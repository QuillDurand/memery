---

title: Core


keywords: fastai
sidebar: home_sidebar



nb_path: "00_core.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 00_core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is the core module, which loads the CLIP model and the encodings of all the images in the folder, then tokenizes the search text or image, and finally returns a sorted list of filenames.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Modular-flow-system">Modular flow system<a class="anchor-link" href="#Modular-flow-system"> </a></h2><p>I'm using the Neural Search design pattern as described by Han Xiao in e.g. <a href="https://hanxiao.io/2019/07/29/Generic-Neural-Elastic-Search-From-bert-as-service-and-Go-Way-Beyond">General Neural Elastic Search and Go Way Beyond</a>&amp;c.</p>
<p>This is a system designed to be scalable and distributed if necessary. Even for a single-machine scenario, I like the functional style of it: grab data, transform it and pass it downstream, all the way from the folder to the output widget.</p>
<p>There are two main types of operater in neural search: <strong>flows</strong> and <strong>executors</strong>.</p>
<p><strong>Flows</strong> are specific patterns of data manipulation and storage. <strong>Executors</strong> are the operators that transform the data within the flow.</p>
<p>There are two core flows to any search system: indexing, and querying. The plan here is to make executors that can be composed into flows and then compose the flows into a UI that supports querying and, to some extent, indexing as well.</p>
<p>The core executors for this use case are:</p>
<ul>
<li>Loader</li>
<li>Crafter</li>
<li>Encoder</li>
<li>Indexer</li>
<li>Ranker</li>
<li>Gateway</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>Gateway Process -- not yet implemented</strong></p>
<p>Takes a query and processes it through either Indexing Flow or Querying Flow, passing along arguments. The main entrypoint for each iteration of the index/query process.</p>
<p>Querying Flow can technically process either text or image search, becuase the CLIP encoder will put them into the same embedding space. So we might as well build in a method for either, and make it available to the user, since it's impressive and useful and relatively easy to build.</p>
<p>Eventually the Gateway process probably needs to be quite complicated, for serving all the different users and for delivering REST APIs to different clients. We'll need a way to accept text and images as HTTP requests and return JSON dictionaries (especially at the encoder, which will remain server-bound more than any other executor).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Usage">Usage<a class="anchor-link" href="#Usage"> </a></h3><p>For now, calling the <a href="/memery/core.html#queryFlow"><code>queryFlow</code></a> process directly is the simplest gateway.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Flows">Flows<a class="anchor-link" href="#Flows"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <a href="/memery/core.html#indexFlow"><code>indexFlow</code></a> checks the local directory for files with image extensions, loads the archive, splits out any new images to be encoded and encodes them, then finally builds a treemap and saves it along with the new archive. It returns a tuple with the locations of the archive and treemap.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="indexFlow" class="doc_header"><code>indexFlow</code><a href="https://github.com/deepfates/memery/tree/main/memery/core.py#L16" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>indexFlow</code>(<strong><code>path</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;images/memery.pt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
<span class="n">Path</span><span class="p">(</span><span class="s1">&#39;images/memery.ann&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">save_paths</span> <span class="o">=</span> <span class="n">indexFlow</span><span class="p">(</span><span class="s1">&#39;./images&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>  0%|          | 0/1 [00:00&lt;?, ?it/s]</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Loaded 0 encodings
Encoding 80 new images
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 1/1 [00:01&lt;00:00,  1.05s/it]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Building treemap
Saving 79images
Done in 1.4366280770045705 seconds
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">save_paths</span>
<span class="n">save_paths</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(&#39;images/memery.pt&#39;, &#39;images/memery.ann&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <a href="/memery/core.html#queryFlow"><code>queryFlow</code></a> takes a path and a query, checks for an index, loads it and searches through the treemap if it exists, and calls <a href="/memery/core.html#indexFlow"><code>indexFlow</code></a> to index it first if it hasn't been.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="queryFlow" class="doc_header"><code>queryFlow</code><a href="https://github.com/deepfates/memery/tree/main/memery/core.py#L43" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>queryFlow</code>(<strong><code>path</code></strong>, <strong><code>query</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">memery.gui</span> <span class="kn">import</span> <span class="n">get_grid</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">root</span> <span class="o">=</span> <span class="s1">&#39;./images&#39;</span>
<span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;dog&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ranked</span> <span class="o">=</span> <span class="n">queryFlow</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Searching 79 images
Done in 0.0929578750001383 seconds
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ranked</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;images/Wholesome-Meme-8.jpg&#39;,
 &#39;images/Wholesome-Meme-5.jpg&#39;,
 &#39;images/Wholesome-Meme-35.jpg&#39;,
 &#39;images/Wholesome-Meme-67.png&#39;,
 &#39;images/embarassed-dog-on-bed-SA2BDZW.jpg&#39;,
 &#39;images/Wholesome-Meme-72.jpg&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">get_grid</span><span class="p">(</span><span class="n">ranked</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>
<p><em>Working out the timing issues in flow</em></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> line_profiler
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">root</span> <span class="o">=</span> <span class="s1">&#39;/home/mage/Pictures/memes/Pixel/Pictures/&#39;</span>
<span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;dog&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Path(f&#39;{root}memery.pt&#39;).unlink()</span>
<span class="c1"># Path(f&#39;{root}memery.ann&#39;).unlink()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">lprun</span> -f indexFlow indexFlow(Path(root))
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>  0%|          | 0/11 [00:00&lt;?, ?it/s]</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Loaded 0 encodings
Encoding 1303 new images
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre> 45%|████▌     | 5/11 [00:06&lt;00:07,  1.21s/it]/home/mage/.local/lib/python3.7/site-packages/PIL/Image.py:963: UserWarning: Palette images with Transparency expressed in bytes should be converted to RGBA images
  &#34;Palette images with Transparency expressed in bytes should be &#34;
100%|██████████| 11/11 [00:12&lt;00:00,  1.11s/it]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Building treemap
Saving 1303images
Done in 18.440638860003673 seconds
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea ">
<pre>Timer unit: 1e-06 s

Total time: 18.4743 s
File: &lt;ipython-input-4-3f277edb55d4&gt;
Function: indexFlow at line 2

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
     2                                           def indexFlow(path):
     3         1         23.0     23.0      0.0      root = Path(path)
     4         1         25.0     25.0      0.0      device = torch.device(&#34;cuda&#34; if torch.cuda.is_available() else &#34;cpu&#34;)
     5                                               
     6         1      32341.0  32341.0      0.2      filepaths = get_image_files(root)
     7         1          1.0      1.0      0.0      archive_db = {}
     8                                               
     9         1       1104.0   1104.0      0.0      archive_db, new_files = archive_loader(filepaths, root, device)
    10         1         97.0     97.0      0.0      print(f&#34;Loaded {len(archive_db)} encodings&#34;)
    11         1         23.0     23.0      0.0      print(f&#34;Encoding {len(new_files)} new images&#34;)
    12                                           
    13         1          3.0      3.0      0.0      start_time = time.perf_counter()
    14                                           
    15         1       1355.0   1355.0      0.0      crafted_files = crafter(new_files, device)
    16         1   12170313.0 12170313.0     65.9      new_embeddings = image_encoder(crafted_files, device)
    17                                               
    18         1       3817.0   3817.0      0.0      db = join_all(archive_db, new_files, new_embeddings)
    19         1         82.0     82.0      0.0      print(&#34;Building treemap&#34;)
    20         1    6216161.0 6216161.0     33.6      t = build_treemap(db)
    21                                               
    22         1         74.0     74.0      0.0      print(f&#34;Saving {len(db)}images&#34;)
    23         1      48820.0  48820.0      0.3      save_paths = save_archives(root, t, db)
    24         1         69.0     69.0      0.0      print(f&#34;Done in {time.perf_counter() - start_time} seconds&#34;)
    25                                               
    26         1          1.0      1.0      0.0      return(save_paths)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">lprun</span> -f queryFlow queryFlow(root, query)
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Searching 1303 images
Done in 0.21823624199896585 seconds
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea ">
<pre>Timer unit: 1e-06 s

Total time: 0.248458 s
File: &lt;ipython-input-8-f0ea29459e86&gt;
Function: queryFlow at line 2

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
     2                                           def queryFlow(path, query): 
     3         1         76.0     76.0      0.0      root = Path(path)
     4         1         24.0     24.0      0.0      device = torch.device(&#34;cuda&#34; if torch.cuda.is_available() else &#34;cpu&#34;)
     5                                               
     6         1         15.0     15.0      0.0      dbpath = root/&#39;memery.pt&#39;
     7         1      29851.0  29851.0     12.0      db = db_loader(dbpath, device)
     8         1         38.0     38.0      0.0      treepath = root/&#39;memery.ann&#39;
     9         1         51.0     51.0      0.0      treemap = treemap_loader(treepath)
    10                                               
    11         1          1.0      1.0      0.0      if treemap == None or db == {}:
    12                                                   dbpath, treepath = indexFlow(root)
    13                                                   treemap = treemap_loader(Path(treepath))
    14                                                   db = db_loader(dbpath, device)
    15                                               
    16         1         99.0     99.0      0.0      print(f&#34;Searching {len(db)} images&#34;)
    17         1          2.0      2.0      0.0      start_time = time.perf_counter()
    18                                               
    19         1       5823.0   5823.0      2.3      query_vec = text_encoder(query, device)
    20         1       5887.0   5887.0      2.4      indexes = ranker(query_vec, treemap)
    21         1     206516.0 206516.0     83.1      ranked_files = nns_to_files(db, indexes)
    22                                               
    23         1         74.0     74.0      0.0      print(f&#34;Done in {time.perf_counter() - start_time} seconds&#34;)
    24                                               
    25         1          1.0      1.0      0.0      return(ranked_files)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">root</span> <span class="o">=</span> <span class="s1">&#39;/home/mage/Pictures/occult-imagery/&#39;</span>
<span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;dog&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">lprun</span> -f queryFlow queryFlow(root, query)
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Searching 26722 images
Done in 96.83730196499528 seconds
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea ">
<pre>Timer unit: 1e-06 s

Total time: 97.4745 s
File: &lt;ipython-input-8-f0ea29459e86&gt;
Function: queryFlow at line 2

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
     2                                           def queryFlow(path, query): 
     3         1         31.0     31.0      0.0      root = Path(path)
     4         1         23.0     23.0      0.0      device = torch.device(&#34;cuda&#34; if torch.cuda.is_available() else &#34;cpu&#34;)
     5                                               
     6         1         16.0     16.0      0.0      dbpath = root/&#39;memery.pt&#39;
     7         1     635653.0 635653.0      0.7      db = db_loader(dbpath, device)
     8         1         28.0     28.0      0.0      treepath = root/&#39;memery.ann&#39;
     9         1        999.0    999.0      0.0      treemap = treemap_loader(treepath)
    10                                               
    11         1          2.0      2.0      0.0      if treemap == None or db == {}:
    12                                                   dbpath, treepath = indexFlow(root)
    13                                                   treemap = treemap_loader(Path(treepath))
    14                                                   db = db_loader(dbpath, device)
    15                                               
    16         1        387.0    387.0      0.0      print(f&#34;Searching {len(db)} images&#34;)
    17         1          1.0      1.0      0.0      start_time = time.perf_counter()
    18                                               
    19         1       4578.0   4578.0      0.0      query_vec = text_encoder(query, device)
    20         1     100370.0 100370.0      0.1      indexes = ranker(query_vec, treemap)
    21         1   96732340.0 96732340.0     99.2      ranked_files = nns_to_files(db, indexes)
    22                                               
    23         1        116.0    116.0      0.0      print(f&#34;Done in {time.perf_counter() - start_time} seconds&#34;)
    24                                               
    25         1          0.0      0.0      0.0      return(ranked_files)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">lprun</span> -f indexFlow indexFlow(Path(root))
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0it [00:00, ?it/s]</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Loaded 26722 encodings
Encoding 0 new images
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0it [00:00, ?it/s]</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Building treemap
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>*** KeyboardInterrupt exception caught in code being profiled.</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea ">
<pre>Timer unit: 1e-06 s

Total time: 11.8187 s
File: &lt;ipython-input-4-3f277edb55d4&gt;
Function: indexFlow at line 2

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
     2                                           def indexFlow(path):
     3         1         19.0     19.0      0.0      root = Path(path)
     4         1         18.0     18.0      0.0      device = torch.device(&#34;cuda&#34; if torch.cuda.is_available() else &#34;cpu&#34;)
     5                                               
     6         1    1228368.0 1228368.0     10.4      filepaths = get_image_files(root)
     7         1          2.0      2.0      0.0      archive_db = {}
     8                                               
     9         1    9014579.0 9014579.0     76.3      archive_db, new_files = archive_loader(filepaths, root, device)
    10         1         83.0     83.0      0.0      print(f&#34;Loaded {len(archive_db)} encodings&#34;)
    11         1         21.0     21.0      0.0      print(f&#34;Encoding {len(new_files)} new images&#34;)
    12                                           
    13         1          2.0      2.0      0.0      start_time = time.perf_counter()
    14                                           
    15         1        334.0    334.0      0.0      crafted_files = crafter(new_files, device)
    16         1     116654.0 116654.0      1.0      new_embeddings = image_encoder(crafted_files, device)
    17                                               
    18         1          9.0      9.0      0.0      db = join_all(archive_db, new_files, new_embeddings)
    19         1         43.0     43.0      0.0      print(&#34;Building treemap&#34;)
    20         1    1458594.0 1458594.0     12.3      t = build_treemap(db)
    21                                               
    22                                               print(f&#34;Saving {len(db)}images&#34;)
    23                                               save_paths = save_archives(root, t, db)
    24                                               print(f&#34;Done in {time.perf_counter() - start_time} seconds&#34;)
    25                                               
    26                                               return(save_paths)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

